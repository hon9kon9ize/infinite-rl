name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch: # Manual trigger only

permissions:
  actions: write

jobs:
  version-check:
    runs-on: ubuntu-latest
    outputs:
      release_exists: ${{ steps.check_release.outputs.release_exists }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine package version
        id: get_version
        shell: bash
        run: |
          set -e
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "PWD=$(pwd)"
          echo "Listing repository root:"
          ls -la "$GITHUB_WORKSPACE" || true

          # Prefer explicit workspace path to avoid issues when working-directory changes
          if [ -f "$GITHUB_WORKSPACE/VERSION.txt" ]; then
            VERSION_RAW=$(cat "$GITHUB_WORKSPACE/VERSION.txt" | tr -d "\n\r " )
          elif [ -f VERSION.txt ]; then
            VERSION_RAW=$(cat VERSION.txt | tr -d "\n\r " )
          else
            echo "ERROR: VERSION.txt not found in repository root (checked $GITHUB_WORKSPACE and PWD)."
            exit 1
          fi

          [[ "$VERSION_RAW" == v* ]] && VERSION="$VERSION_RAW" || VERSION="v$VERSION_RAW"
          echo "Found version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Check for existing release
        id: check_release
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="runtimes-${{ steps.get_version.outputs.version }}"
          resp=$(curl -sS -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG" || true)
          if echo "$resp" | jq -e '.id' >/dev/null 2>&1; then
            echo "release_exists=true" >> "$GITHUB_OUTPUT"
            echo "upload_url=$(echo "$resp" | jq -r '.upload_url' | sed 's/{?name,label}//')" >> "$GITHUB_OUTPUT"
          else
            echo "release_exists=false" >> "$GITHUB_OUTPUT"
          fi

  test:
    needs: version-check
    # Only run when this is not a workflow_run event OR when the triggering workflow succeeded
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Exit if release missing
        if: ${{ needs.version-check.outputs.release_exists == 'false' }}
        run: |
          echo "Release runtimes-${{ needs.version-check.outputs.version }} not found. Exiting CI run."
          exit 0

      - name: Continue when release present
        if: ${{ needs.version-check.outputs.release_exists == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python
        if: ${{ needs.version-check.outputs.release_exists == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        if: ${{ needs.version-check.outputs.release_exists == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y nodejs openjdk-17-jdk g++

      - name: Install Python package from git (will trigger build and download runtimes)
        if: ${{ needs.version-check.outputs.release_exists == 'true' }}
        env:
          # Tell setup.py which release tag to fetch runtimes from (version is like 'vX.Y.Z')
          RUNTIME_RELEASE_TAG: ${{ needs.version-check.outputs.version }}
          # Allow override of repo if needed (defaults to package value)
          RUNTIME_GITHUB_REPO: ${{ github.repository }}
          # Provide token to avoid GitHub API rate limits when discovering/downloading runtimes
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m pip install --upgrade pip
          # Install from the corresponding runtimes release tag (e.g., runtimes-v0.1.16)
          # This builds a wheel and triggers our build-time hook to bundle runtimes into the wheel.
          pip install git+https://github.com/${{ github.repository }}@runtimes-${{ needs.version-check.outputs.version }}
          pip install pytest

      - name: Run unit tests
        if: ${{ needs.version-check.outputs.release_exists == 'true' }}
        run: |
          python -m unittest discover tests

  schedule_retry:
    needs: version-check
    if: ${{ needs.version-check.outputs.release_exists == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait 10 minutes
        run: sleep 600

      - name: Trigger CI workflow after delay
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering CI workflow dispatch for main branch"
          curl -X POST -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/ci.yml/dispatches \
            -d '{"ref":"main"}'
